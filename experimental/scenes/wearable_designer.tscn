[gd_scene load_steps=23 format=3 uid="uid://du5ijsydyirmv"]

[ext_resource type="Script" uid="uid://5xlrluaqi8p0" path="res://experimental/scripts/wearable_designer.gd" id="1_fe8b1"]
[ext_resource type="Shader" uid="uid://bu32bxcuo17mi" path="res://shaders/grid.gdshader" id="1_l7n01"]
[ext_resource type="Script" uid="uid://bgtgv8c7khc0k" path="res://scripts/world/camera_controls.gd" id="2_nvkp8"]
[ext_resource type="Script" uid="uid://kt8qylpxwnvv" path="res://experimental/scripts/neopixel_generator.gd" id="3_pirp3"]
[ext_resource type="ArrayMesh" uid="uid://bqa7k1th513al" path="res://experimental/graphics/neopixel_strip_1.obj" id="4_c4ipb"]
[ext_resource type="PackedScene" uid="uid://ci3ugvvfqe1qy" path="res://scenes/code_editor.tscn" id="4_vbu5l"]
[ext_resource type="Script" uid="uid://4as1lu3lsvt8" path="res://resources/boards/board_resource.gd" id="5_x4ab7"]
[ext_resource type="Resource" uid="uid://cqwrnue4ejuti" path="res://resources/boards/arduino_uno.tres" id="6_8ulwq"]
[ext_resource type="Resource" uid="uid://dk6ttd5b555tv" path="res://resources/boards/ESP32-C6_Feather.tres" id="7_3mvgf"]
[ext_resource type="Resource" uid="uid://6k38vih27ib6" path="res://resources/boards/rp2040_trinkey.tres" id="7_fe8b1"]
[ext_resource type="Resource" uid="uid://m2dk08ne2po" path="res://resources/boards/garden_board.tres" id="8_y8gkd"]
[ext_resource type="Theme" uid="uid://etxhywncatso" path="res://graphics/global_theme.tres" id="11_y8gkd"]

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_vbu5l"]
sky_horizon_color = Color(0.662243, 0.671743, 0.686743, 1)
ground_horizon_color = Color(0.662243, 0.671743, 0.686743, 1)

[sub_resource type="Sky" id="Sky_go7bl"]
sky_material = SubResource("ProceduralSkyMaterial_vbu5l")

[sub_resource type="Environment" id="Environment_xwkll"]
background_mode = 1
background_color = Color(0.0562916, 0.0562916, 0.0562915, 1)
background_energy_multiplier = 16.0
sky = SubResource("Sky_go7bl")
tonemap_mode = 2
tonemap_exposure = 0.7
fog_enabled = true
fog_light_energy = 0.05

[sub_resource type="ShaderMaterial" id="ShaderMaterial_yjqe1"]
render_priority = 0
shader = ExtResource("1_l7n01")
shader_parameter/subdivisions = 32.0
shader_parameter/grid_width = 0.02
shader_parameter/background_color = Color(0.2, 0.2, 0.2, 1)
shader_parameter/background_color_two = Color(0.1, 0.1, 0.1, 1)
shader_parameter/grid_color = Color(0.5, 0.5, 0.5, 1)
shader_parameter/dashed_scale_x = 0.5
shader_parameter/dashed_scale_y = 0.5
shader_parameter/dashed_count_x = 1.0
shader_parameter/dashed_count_y = 1.0
shader_parameter/point_width = 0.3
shader_parameter/point_color = Color(0, 0, 0, 1)
shader_parameter/point_scale_x = 0.05
shader_parameter/point_scale_y = 0.05
shader_parameter/inside_width = 0.01
shader_parameter/inside_subdivisions = 6.0
shader_parameter/inside_color = Color(0.4, 0.4, 0.4, 1)
shader_parameter/in_dashed_scale_x = 0.3
shader_parameter/in_dashed_scale_y = 0.3
shader_parameter/in_dashed_count_x = 6.0
shader_parameter/in_dashed_count_y = 6.0

[sub_resource type="BoxMesh" id="BoxMesh_fr2ie"]
material = SubResource("ShaderMaterial_yjqe1")
size = Vector3(50, 0.2, 50)

[sub_resource type="Curve3D" id="Curve3D_udhm1"]
_data = {
"points": PackedVector3Array(0, 0, 0, 0, 0, 0, 0.70415735, 0, 0.4233743, 0, 0, 0, 0, 0, 0, -1.2694843, 0, 0.5162554),
"tilts": PackedFloat32Array(0, 0)
}
point_count = 2

[sub_resource type="MultiMesh" id="MultiMesh_qbyt5"]
transform_format = 1
use_colors = true
use_custom_data = true
instance_count = 17
mesh = ExtResource("4_c4ipb")
buffer = PackedFloat32Array(-0.047008507, 0, 0.9988946, 0.65355086, 0, 1, 0, 0, -0.99889445, 0, -0.047008514, 0.42575592, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008626, 0, 0.9988945, 0.54124117, 0, 1, 0, 0, -0.9988945, 0, -0.047008626, 0.43104124, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008507, 0, 0.9988945, 0.43187457, 0, 1, 0, 0, -0.9988945, 0, -0.047008507, 0.43618813, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700891, 0, 0.99889445, 0.32210436, 0, 1, 0, 0, -0.99889445, 0, -0.04700891, 0.44135398, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700909, 0, 0.99889445, 0.21108425, 0, 1, 0, 0, -0.99889445, 0, -0.04700909, 0.44657868, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008734, 0, 0.99889445, 0.1004774, 0, 1, 0, 0, -0.99889445, 0, -0.047008734, 0.45178393, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008578, 0, 0.9988945, -0.008970492, 0, 1, 0, 0, -0.9988945, 0, -0.047008578, 0.45693466, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700865, 0, 0.99889445, -0.11966869, 0, 1, 0, 0, -0.99889445, 0, -0.04700865, 0.4621442, 0, 0, 0, 0, 0, 0, 0, 0, -0.047009245, 0, 0.9988945, -0.22963908, 0, 1, 0, 0, -0.9988945, 0, -0.047009245, 0.46731943, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008652, 0, 0.99889445, -0.33987886, 0, 1, 0, 0, -0.99889445, 0, -0.047008652, 0.47250742, 0, 0, 0, 0, 0, 0, 0, 0, -0.047008917, 0, 0.9988945, -0.44978744, 0, 1, 0, 0, -0.9988945, 0, -0.047008917, 0.47767982, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700849, 0, 0.9988945, -0.56054103, 0, 1, 0, 0, -0.9988945, 0, -0.04700849, 0.48289198, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700848, 0, 0.9988945, -0.67009526, 0, 1, 0, 0, -0.9988945, 0, -0.04700848, 0.48804766, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700905, 0, 0.99889445, -0.7804744, 0, 1, 0, 0, -0.99889445, 0, -0.04700905, 0.49324217, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700856, 0, 0.9988945, -0.89161867, 0, 1, 0, 0, -0.9988945, 0, -0.04700856, 0.49847272, 0, 0, 0, 0, 0, 0, 0, 0, -0.04700902, 0, 0.9988945, -1.0015675, 0, 1, 0, 0, -0.9988945, 0, -0.04700902, 0.50364697, 0, 0, 0, 0, 0, 0, 0, 0, -0.047009483, 0, 0.9988944, -1.111012, 0, 1, 0, 0, -0.99889445, 0, -0.04700948, 0.5087975, 0, 0, 0, 0, 0, 0, 0, 0)

[sub_resource type="Shader" id="Shader_x4ab7"]
code = "shader_type spatial;
render_mode unshaded;

uniform sampler2D screen_texture : source_color, hint_screen_texture, filter_nearest;
uniform sampler2D depth_texture : source_color, hint_depth_texture, filter_nearest;
uniform sampler2D normal_texture : source_color, hint_normal_roughness_texture, filter_nearest;

uniform float depth_threshold : hint_range(0, 1) = 0.05;
uniform float reverse_depth_threshold : hint_range(0, 1) = 0.25;
uniform float normal_threshold : hint_range(0, 1) = 0.6;

uniform float darken_amount : hint_range(0, 1, 0.01) = 0.3;
uniform float lighten_amount : hint_range(0, 10, 0.01) = 1.5;

uniform vec3 normal_edge_bias = vec3(1, 1, 1);
uniform vec3 light_direction = vec3(-0.96, -0.18, 0.2);

float get_depth(vec2 screen_uv, mat4 inv_projection_matrix) {
	float depth = texture(depth_texture, screen_uv).r;
	vec3 ndc = vec3(screen_uv * 2.0 - 1.0, depth);
	vec4 view = inv_projection_matrix * vec4(ndc, 1.0);
	view.xyz /= view.w;
	return -view.z;
}

void vertex() {
	POSITION = vec4(VERTEX, 1.0);
}

void fragment() {
	float depth = get_depth(SCREEN_UV, INV_PROJECTION_MATRIX);
	vec3 normal = texture(normal_texture, SCREEN_UV).xyz * 2.0 - 1.0;
	vec2 texel_size = 1.0 / VIEWPORT_SIZE.xy;

	vec2 uvs[4];
	uvs[0] = vec2(SCREEN_UV.x, min(1.0 - 0.001, SCREEN_UV.y + texel_size.y));
	uvs[1] = vec2(SCREEN_UV.x, max(0.0, SCREEN_UV.y - texel_size.y));
	uvs[2] = vec2(min(1.0 - 0.001, SCREEN_UV.x + texel_size.x), SCREEN_UV.y);
	uvs[3] = vec2(max(0.0, SCREEN_UV.x - texel_size.x), SCREEN_UV.y);

	float depth_diff = 0.0;
	float depth_diff_reversed = 0.0;
	float nearest_depth = depth;
	vec2 nearest_uv = SCREEN_UV;

	float normal_sum = 0.0;
	for (int i = 0; i < 4; i++) {
		float d = get_depth(uvs[i], INV_PROJECTION_MATRIX);
		depth_diff += depth - d;
		depth_diff_reversed += d - depth;

		if (d < nearest_depth) {
			nearest_depth = d;
			nearest_uv = uvs[i];
		}

		vec3 n = texture(normal_texture, uvs[i]).xyz * 2.0 - 1.0;
		vec3 normal_diff = normal - n;

		// Edge pixels should yield to the normal closest to the bias direction
		float normal_bias_diff = dot(normal_diff, normal_edge_bias);
		float normal_indicator = smoothstep(-0.01, 0.01, normal_bias_diff);

		normal_sum += dot(normal_diff, normal_diff) * normal_indicator;
	}
	float depth_edge = step(depth_threshold, depth_diff);

	// The reverse depth sum produces depth lines inside of the object, but they don't look as nice as the normal depth_diff
	// Instead, we can use this value to mask the normal edge along the outside of the object
	float reverse_depth_edge = step(reverse_depth_threshold, depth_diff_reversed);

	float indicator = sqrt(normal_sum);
	float normal_edge = step(normal_threshold, indicator - reverse_depth_edge);

	vec3 original = texture(screen_texture, SCREEN_UV).rgb;
	vec3 nearest = texture(screen_texture, nearest_uv).rgb;

	mat3 view_to_world_normal_mat = mat3(
            INV_VIEW_MATRIX[0].xyz,
            INV_VIEW_MATRIX[1].xyz,
            INV_VIEW_MATRIX[2].xyz
	);
	float ld = dot((view_to_world_normal_mat * normal), normalize(light_direction));

	vec3 depth_col = nearest * darken_amount;
	vec3 normal_col = original * (ld > 0.0 ? darken_amount : lighten_amount);
	vec3 edge_mix = mix(normal_col, depth_col, depth_edge);

	ALBEDO = mix(original, edge_mix, (depth_edge > 0.0 ? depth_edge : normal_edge));
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_go7bl"]
render_priority = 0
shader = SubResource("Shader_x4ab7")
shader_parameter/depth_threshold = 0.05
shader_parameter/reverse_depth_threshold = 0.25
shader_parameter/normal_threshold = 0.6
shader_parameter/darken_amount = 0.3
shader_parameter/lighten_amount = 1.5
shader_parameter/normal_edge_bias = Vector3(1, 1, 1)
shader_parameter/light_direction = Vector3(-0.96, -0.18, 0.2)

[sub_resource type="QuadMesh" id="QuadMesh_8ulwq"]
material = SubResource("ShaderMaterial_go7bl")
flip_faces = true
size = Vector2(2, 2)

[node name="WearableDesigner" type="Node3D"]
script = ExtResource("1_fe8b1")

[node name="SubViewportContainer" type="SubViewportContainer" parent="."]
texture_filter = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="SubViewport" type="SubViewport" parent="SubViewportContainer"]
handle_input_locally = false
physics_object_picking = true
physics_object_picking_sort = true
physics_object_picking_first_only = true
size = Vector2i(1280, 720)
render_target_update_mode = 4

[node name="WorldEnvironment" type="WorldEnvironment" parent="SubViewportContainer/SubViewport"]
environment = SubResource("Environment_xwkll")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="SubViewportContainer/SubViewport"]
transform = Transform3D(0.0767869, 0.996376, 0.0365883, 0.57301, -0.0741313, 0.816189, 0.815943, -0.0417072, -0.576625, -4.7528, 8.03853, -8.90619)
shadow_enabled = true

[node name="Ground" type="MeshInstance3D" parent="SubViewportContainer/SubViewport"]
mesh = SubResource("BoxMesh_fr2ie")

[node name="Path3D" type="Path3D" parent="SubViewportContainer/SubViewport"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.4392748, 0)
curve = SubResource("Curve3D_udhm1")
script = ExtResource("3_pirp3")
distance_between = 0.11

[node name="MultiMeshInstance3D" type="MultiMeshInstance3D" parent="SubViewportContainer/SubViewport/Path3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0.0023622513)
multimesh = SubResource("MultiMesh_qbyt5")

[node name="CameraControl" type="Node3D" parent="SubViewportContainer/SubViewport"]
transform = Transform3D(0.99999976, 0, 0, 0, 0.866025, 0.49999973, 0, -0.49999976, 0.8660249, -0.22320724, 0.46578, 0.4062995)
script = ExtResource("2_nvkp8")
snap = false

[node name="Camera3D" type="Camera3D" parent="SubViewportContainer/SubViewport/CameraControl"]
unique_name_in_owner = true
transform = Transform3D(1, 0, 0, 0, 1, -2.9802294e-08, 0, 2.9802294e-08, 1, 0.438132, 0.0395386, 48.8111)
projection = 1
far = 200.0

[node name="MeshInstance3D" type="MeshInstance3D" parent="SubViewportContainer/SubViewport/CameraControl/Camera3D"]
transform = Transform3D(1, 0, 0, 0, 0.866025, -0.5, 0, 0.5, 0.866025, 0.43998, 0.0500045, -0.175917)
extra_cull_margin = 16384.0
mesh = SubResource("QuadMesh_8ulwq")

[node name="CodeEditor" parent="." instance=ExtResource("4_vbu5l")]
boards_info = Array[ExtResource("5_x4ab7")]([ExtResource("6_8ulwq"), ExtResource("7_fe8b1"), ExtResource("8_y8gkd"), ExtResource("7_3mvgf")])
saving_enabled = false

[node name="CodeEdit" parent="CodeEditor" index="0"]
text = "#include FastLED.h

void setup() {
  Serial.begin(115200);
	
}

void loop() {
	
}"

[node name="FastLEDButton" type="Button" parent="."]
anchors_preset = 6
anchor_left = 1.0
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
offset_left = -71.0
offset_top = -28.5
offset_bottom = 28.5
grow_horizontal = 0
grow_vertical = 2
theme = ExtResource("11_y8gkd")

[connection signal="focus_entered" from="SubViewportContainer" to="SubViewportContainer/SubViewport/CameraControl" method="_on_code_edit_focus_entered"]
[connection signal="focus_exited" from="SubViewportContainer" to="SubViewportContainer/SubViewport/CameraControl" method="_on_code_edit_focus_exited"]
[connection signal="curve_changed" from="SubViewportContainer/SubViewport/Path3D" to="SubViewportContainer/SubViewport/Path3D" method="_on_curve_changed"]
[connection signal="pressed" from="FastLEDButton" to="." method="_compile_fastled"]

[editable path="CodeEditor"]
